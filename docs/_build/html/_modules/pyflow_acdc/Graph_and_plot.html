<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyflow_acdc.Graph_and_plot &#8212; pyflow acdc  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyflow_acdc.Graph_and_plot</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.io</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.Classes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node_AC</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">branca</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">folium.plugins</span><span class="w"> </span><span class="kn">import</span> <span class="n">Draw</span><span class="p">,</span><span class="n">MarkerCluster</span><span class="p">,</span><span class="n">AntPath</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineString</span> <span class="p">,</span> <span class="n">MultiPoint</span><span class="p">,</span> <span class="n">Point</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">webbrowser</span>
    <span class="n">map_tac</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">map_tac</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;plot_Graph&#39;</span><span class="p">,</span>
    <span class="s1">&#39;plot_neighbour_graph&#39;</span><span class="p">,</span>
    <span class="s1">&#39;plot_TS_res&#39;</span><span class="p">,</span>
    <span class="s1">&#39;plot_folium&#39;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_ACnode_hovertext</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>
    <span class="c1"># print(f&quot;Updating hover text for node: {node.name}&quot;)</span>
    <span class="n">dec</span><span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span>
        <span class="n">Load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">PLi</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">x_cord</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">x_coord</span>
        <span class="n">y_cord</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">y_coord</span>
        <span class="n">PZ</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">PZ</span>
        <span class="n">node</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;coord: </span><span class="si">{</span><span class="n">x_cord</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y_cord</span><span class="si">}</span><span class="s2">&lt;br&gt;Type: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&lt;br&gt;Load: </span><span class="si">{</span><span class="n">Load</span><span class="si">}</span><span class="s2">&lt;br&gt;Area: </span><span class="si">{</span><span class="n">PZ</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">PGi</span><span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">PGi</span><span class="o">+</span><span class="n">node</span><span class="o">.</span><span class="n">PGi_ren</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">curtailment</span> <span class="o">+</span><span class="n">node</span><span class="o">.</span><span class="n">PGi_opt</span>
            <span class="n">Gen</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">PGi</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">Load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">PLi</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">P_s</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">PZ</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">PZ</span>
            <span class="n">node</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;Voltage: </span><span class="si">{</span><span class="n">V</span><span class="si">}</span><span class="s2">&lt;br&gt;Angle: </span><span class="si">{</span><span class="n">theta</span><span class="si">}</span><span class="s2">&lt;br&gt;Generation: </span><span class="si">{</span><span class="n">Gen</span><span class="si">}</span><span class="s2">&lt;br&gt;Load: </span><span class="si">{</span><span class="n">Load</span><span class="si">}</span><span class="s2">&lt;br&gt;Converters: </span><span class="si">{</span><span class="n">conv</span><span class="si">}</span><span class="s2">&lt;br&gt;PZ: </span><span class="si">{</span><span class="n">PZ</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="n">V</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">kV_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">theta</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">PGi</span><span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">PGi</span><span class="o">+</span><span class="n">node</span><span class="o">.</span><span class="n">PGi_ren</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">curtailment</span>  <span class="o">+</span><span class="n">node</span><span class="o">.</span><span class="n">PGi_opt</span>
            <span class="n">Gen</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">PGi</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">Load</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">PLi</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">P_s</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">PZ</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">PZ</span>
            <span class="n">node</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;Voltage: </span><span class="si">{</span><span class="n">V</span><span class="si">}</span><span class="s2">kV&lt;br&gt;Angle: </span><span class="si">{</span><span class="n">theta</span><span class="si">}</span><span class="s2">Â°&lt;br&gt;Generation: </span><span class="si">{</span><span class="n">Gen</span><span class="si">}</span><span class="s2">MW&lt;br&gt;Load: </span><span class="si">{</span><span class="n">Load</span><span class="si">}</span><span class="s2">MW&lt;br&gt;Converters: </span><span class="si">{</span><span class="n">conv</span><span class="si">}</span><span class="s2">MW&lt;br&gt;PZ: </span><span class="si">{</span><span class="n">PZ</span><span class="si">}</span><span class="s2">&quot;</span>
                
                    
<span class="k">def</span><span class="w"> </span><span class="nf">update_DCnode_hovertext</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>            
    <span class="n">dec</span><span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span>
        <span class="n">Load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">PLi</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">x_cord</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">x_coord</span>
        <span class="n">y_cord</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">y_coord</span>
        <span class="n">PZ</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">PZ</span>
        <span class="n">node</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;coord: </span><span class="si">{</span><span class="n">x_cord</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">y_cord</span><span class="si">}</span><span class="s2">&lt;br&gt;Type: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&lt;br&gt;Load: </span><span class="si">{</span><span class="n">Load</span><span class="si">}</span><span class="s2">&lt;br&gt;Area: </span><span class="si">{</span><span class="n">PZ</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>   
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">conv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Pconv</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;Voltage: </span><span class="si">{</span><span class="n">V</span><span class="si">}</span><span class="s2">&lt;br&gt;&lt;br&gt;Converter: </span><span class="si">{</span><span class="n">conv</span><span class="si">}</span><span class="s2">&quot;</span>
           
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">kV_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ConvInv</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">Nconv</span> <span class="o">&gt;=</span> <span class="mf">0.00001</span><span class="p">:</span>
            <span class="n">conv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">P</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">nconv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Nconv</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">load</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">conv_loading</span> <span class="o">*</span> <span class="n">S_base</span> <span class="o">/</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">conv_MW</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Nconv</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
            <span class="n">node</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;Voltage: </span><span class="si">{</span><span class="n">V</span><span class="si">}</span><span class="s2">kV&lt;br&gt;Converter:</span><span class="si">{</span><span class="n">conv</span><span class="si">}</span><span class="s2">MW&lt;br&gt;Number Converter: </span><span class="si">{</span><span class="n">nconv</span><span class="si">}</span><span class="s2">&lt;br&gt;Converters loading: </span><span class="si">{</span><span class="n">load</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;Voltage: </span><span class="si">{</span><span class="n">V</span><span class="si">}</span><span class="s2">kV&quot;</span>
     
            
            
<span class="k">def</span><span class="w"> </span><span class="nf">update_lineAC_hovertext</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>
    <span class="n">dec</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">line</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;from&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">fromS</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;to&#39;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Length_km</span><span class="p">)</span>
        <span class="n">z</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">y</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Line_tf</span> <span class="o">=</span> <span class="s1">&#39;Transformer&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isTf</span> <span class="k">else</span> <span class="s1">&#39;Line&#39;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Line_tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; Z:</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&lt;br&gt;Y:</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&lt;br&gt;Length: </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">km&lt;br&gt;Rating: </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s2">MVA&quot;</span>

    <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
        
        <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sto</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">Line_tf</span> <span class="o">=</span> <span class="s1">&#39;Transformer&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isTf</span> <span class="k">else</span> <span class="s1">&#39;Line&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Line_tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;S from: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">&lt;br&gt;S to: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Line_tf</span> <span class="o">=</span> <span class="s1">&#39;Transformer&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isTf</span> <span class="k">else</span> <span class="s1">&#39;Line&#39;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Line_tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;S from: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;S to: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>
              
<span class="k">def</span><span class="w"> </span><span class="nf">update_lineDC_hovertext</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>            
    <span class="n">dec</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">line</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;from&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">fromP</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;to&#39;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        
        <span class="n">r</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Length_km</span><span class="p">)</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">MW_rating</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Line: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; R:</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&lt;br&gt;Length:</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">km&lt;br&gt;Rating: </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s2">MW&quot;</span>

    <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
     
        <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Pfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromP</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">Pto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toP</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">np_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np_line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Pfrom</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Pto</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">MW_rating</span><span class="o">*</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Pfrom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Line: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;P from: </span><span class="si">{</span><span class="n">Pfrom</span><span class="si">}</span><span class="s2">&lt;br&gt;P to: </span><span class="si">{</span><span class="n">Pto</span><span class="si">}</span><span class="s2">&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>
            
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Pfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromP</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Pto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toP</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">np_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np_line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Pfrom</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Pto</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">MW_rating</span><span class="o">*</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">Pfrom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Line: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;P from: </span><span class="si">{</span><span class="n">Pfrom</span><span class="si">}</span><span class="s2">MW&lt;br&gt;P to: </span><span class="si">{</span><span class="n">Pto</span><span class="si">}</span><span class="s2">MW&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&lt;br&gt;Number Lines: </span><span class="si">{</span><span class="n">np_line</span><span class="si">}</span><span class="s2">&quot;</span>



<span class="k">def</span><span class="w"> </span><span class="nf">update_lineACexp_hovertext</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>        
    <span class="n">dec</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">line</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;from&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">fromS</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;to&#39;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Length_km</span><span class="p">)</span>
        <span class="n">z</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">y</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Line_tf</span> <span class="o">=</span> <span class="s1">&#39;Transformer&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isTf</span> <span class="k">else</span> <span class="s1">&#39;Line&#39;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Line_tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; Z:</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&lt;br&gt;Y:</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&lt;br&gt;Length: </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">km&lt;br&gt;Rating: </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s2">MVA&quot;</span>

    <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
        
        <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sto</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">np_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np_line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span><span class="o">*</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>    
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">Line_tf</span> <span class="o">=</span> <span class="s1">&#39;Transformer&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isTf</span> <span class="k">else</span> <span class="s1">&#39;Line&#39;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Line_tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;S from: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">&lt;br&gt;S to: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&lt;br&gt;Lines: </span><span class="si">{</span><span class="n">np_line</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">np_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np_line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span><span class="o">*</span><span class="n">line</span><span class="o">.</span><span class="n">np_line</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">Line_tf</span> <span class="o">=</span> <span class="s1">&#39;Transformer&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isTf</span> <span class="k">else</span> <span class="s1">&#39;Line&#39;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Line: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;S from: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;S to: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&lt;br&gt;Lines: </span><span class="si">{</span><span class="n">np_line</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">update_tf_hovertext</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>            
     <span class="n">dec</span><span class="o">=</span><span class="mi">2</span>
     <span class="n">line</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;from&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">fromS</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;to&#39;</span>
     <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
         <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
         <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
         <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
         <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Length_km</span><span class="p">)</span>
         <span class="n">z</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
         <span class="n">y</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
         <span class="n">rating</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span>
         <span class="n">rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">Line_tf</span> <span class="o">=</span> <span class="s1">&#39;Transformer&#39;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isTf</span> <span class="k">else</span> <span class="s1">&#39;Line&#39;</span>
         <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Line_tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; Z:</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&lt;br&gt;Y:</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&lt;br&gt;Length: </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">km&lt;br&gt;Rating: </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s2">MVA&quot;</span>

     <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
         
         <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
         <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
         <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
         <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
         <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
         <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sto</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span><span class="o">*</span><span class="mi">100</span>
         <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Transformer: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;S from: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">&lt;br&gt;S to: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>
     <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">fromS</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">toS</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="n">line</span><span class="o">.</span><span class="n">MVA_rating</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">line</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Transformer: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  </span><span class="si">{</span><span class="n">line_string</span><span class="si">}</span><span class="s2">&lt;br&gt;S from: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;S to: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>
  
<span class="k">def</span><span class="w"> </span><span class="nf">update_conv_hovertext</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>            
     <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
         <span class="n">name</span><span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">name</span>
         <span class="n">fromnode</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_DC</span><span class="o">.</span><span class="n">name</span>
         <span class="n">tonode</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_AC</span><span class="o">.</span><span class="n">name</span>
         <span class="n">rating</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">MVA_max</span>
         <span class="n">rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">conv</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Converter: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;DC node: </span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2">&lt;br&gt;AC node: </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&lt;br&gt;Rating: </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s2">&quot;</span>    
         
     <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
         <span class="n">name</span><span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">name</span>
         <span class="n">fromnode</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_DC</span><span class="o">.</span><span class="n">name</span>
         <span class="n">tonode</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_AC</span><span class="o">.</span><span class="n">name</span>
         <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">P_DC</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">P_AC</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">conv</span><span class="o">.</span><span class="n">Q_AC</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">P_AC</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sto</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="n">conv</span><span class="o">.</span><span class="n">MVA_max</span><span class="o">*</span><span class="mi">100</span>
         <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">conv_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">conv_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="n">conv</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Converter: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  </span><span class="si">{</span><span class="n">conv_string</span><span class="si">}</span><span class="s2">&lt;br&gt;P DC: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">&lt;br&gt;S AC: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>    
         
     <span class="k">else</span><span class="p">:</span>    
        <span class="n">name</span><span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fromnode</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_DC</span><span class="o">.</span><span class="n">name</span>
        <span class="n">tonode</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_AC</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Sfrom</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">P_DC</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Sto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">P_AC</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">conv</span><span class="o">.</span><span class="n">Q_AC</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">S_base</span><span class="o">*</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">P_AC</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">P_AC</span><span class="p">)),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Sto</span><span class="p">))</span><span class="o">*</span><span class="n">S_base</span><span class="o">/</span><span class="n">conv</span><span class="o">.</span><span class="n">MVA_max</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sfrom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conv_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fromnode</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">tonode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">conv</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Converter: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  </span><span class="si">{</span><span class="n">conv_string</span><span class="si">}</span><span class="s2">&lt;br&gt;P DC: </span><span class="si">{</span><span class="n">Sfrom</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;S AC: </span><span class="si">{</span><span class="n">Sto</span><span class="si">}</span><span class="s2">MVA&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>    
        
<span class="k">def</span><span class="w"> </span><span class="nf">update_gen_hovertext</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>            
     <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
         <span class="n">name</span><span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">name</span>
         <span class="n">node</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">Node_AC</span>
         <span class="k">if</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_S</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="n">rating</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_pow_gen</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_S</span><span class="o">*</span><span class="n">S_base</span>
         <span class="n">rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         
         <span class="n">gen</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Generator: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;AC node: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&lt;br&gt;Rating: </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s2">&lt;br&gt;Fuel: </span><span class="si">{</span><span class="n">gen</span><span class="o">.</span><span class="n">gen_type</span><span class="si">}</span><span class="s2">&quot;</span>    
         
     <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
         <span class="n">name</span><span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">name</span>
         <span class="n">Pto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">PGen</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">Qto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">QGen</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_S</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="n">rating</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_pow_gen</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_S</span>
         <span class="n">load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pto</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Qto</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">rating</span><span class="o">*</span><span class="mi">100</span>
         <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         
         <span class="n">gen</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Generator: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; P gen: </span><span class="si">{</span><span class="n">Pto</span><span class="si">}</span><span class="s2">&lt;br&gt;Q Gen: </span><span class="si">{</span><span class="n">Qto</span><span class="si">}</span><span class="s2">&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>   
     <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Pto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">PGen</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Qto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">QGen</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_S</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_pow_gen</span><span class="o">*</span><span class="n">S_base</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">rating</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">Max_S</span><span class="o">*</span><span class="n">S_base</span>
        <span class="n">load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pto</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Qto</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">rating</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">Loading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="n">gen</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Generator: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt; P gen: </span><span class="si">{</span><span class="n">Pto</span><span class="o">*</span><span class="n">S_base</span><span class="si">}</span><span class="s2">MW&lt;br&gt;Q Gen: </span><span class="si">{</span><span class="n">Qto</span><span class="o">*</span><span class="n">S_base</span><span class="si">}</span><span class="s2">MVAR&lt;br&gt;Loading: </span><span class="si">{</span><span class="n">Loading</span><span class="si">}</span><span class="s2">%&quot;</span>    
        
<span class="k">def</span><span class="w"> </span><span class="nf">update_renSource_hovertext</span><span class="p">(</span><span class="n">renSource</span><span class="p">,</span><span class="n">S_base</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>            
     <span class="k">if</span> <span class="n">text</span> <span class="o">==</span><span class="s1">&#39;data&#39;</span><span class="p">:</span>
         <span class="n">name</span><span class="o">=</span> <span class="n">renSource</span><span class="o">.</span><span class="n">name</span>
         <span class="n">node</span> <span class="o">=</span> <span class="n">renSource</span><span class="o">.</span><span class="n">Node</span>
         <span class="n">rating</span> <span class="o">=</span> <span class="n">renSource</span><span class="o">.</span><span class="n">PGi_ren_base</span>
         <span class="n">rating</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">renSource</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ren Source: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;AC node: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&lt;br&gt;Rating: </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s2">&lt;br&gt;Tech: </span><span class="si">{</span><span class="n">renSource</span><span class="o">.</span><span class="n">rs_type</span><span class="si">}</span><span class="s2">&quot;</span>    
         
     <span class="k">elif</span> <span class="n">text</span><span class="o">==</span><span class="s1">&#39;inPu&#39;</span><span class="p">:</span>
         <span class="n">name</span><span class="o">=</span> <span class="n">renSource</span><span class="o">.</span><span class="n">name</span>
         <span class="n">Pto</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">renSource</span><span class="o">.</span><span class="n">PGi_ren</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">Curt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">renSource</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="n">renSource</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ren Source: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  P : </span><span class="si">{</span><span class="n">Pto</span><span class="si">}</span><span class="s2">&lt;br&gt;Curtailment: </span><span class="si">{</span><span class="n">Curt</span><span class="si">}</span><span class="s2">%&quot;</span>    
     <span class="k">else</span><span class="p">:</span>
         
        <span class="n">name</span><span class="o">=</span> <span class="n">renSource</span><span class="o">.</span><span class="n">name</span>
        <span class="n">Pto</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">renSource</span><span class="o">.</span><span class="n">PGi_ren</span><span class="o">*</span><span class="n">S_base</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Curt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">renSource</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">renSource</span><span class="o">.</span><span class="n">hover_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ren Source: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;br&gt;  P : </span><span class="si">{</span><span class="n">Pto</span><span class="si">}</span><span class="s2">MW&lt;br&gt;Curtailment: </span><span class="si">{</span><span class="n">Curt</span><span class="si">}</span><span class="s2">%&quot;</span>    
        
    
                            
                            
                             
<span class="k">def</span><span class="w"> </span><span class="nf">update_hovertexts</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>
    <span class="n">S_base</span><span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">S_base</span>        
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_AC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Update hover texts for nodes</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_AC</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_ACnode_hovertext</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_DC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_DC</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_DCnode_hovertext</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Update hover texts for lines</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_lineAC_hovertext</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_DC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_DC</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_lineDC_hovertext</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_exp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_exp</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_lineACexp_hovertext</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_tf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_tf</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_tf_hovertext</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">Converters_ACDC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">conv</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">Converters_ACDC</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_conv_hovertext</span><span class="p">,</span> <span class="n">conv</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">Generators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">Generators</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_gen_hovertext</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">RenSources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">renSource</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">RenSources</span><span class="p">:</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">update_renSource_hovertext</span><span class="p">,</span> <span class="n">renSource</span><span class="p">,</span> <span class="n">S_base</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>        

        <span class="c1"># Wait for all futures to complete</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># This will block until the task is finished</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in thread: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
<span class="k">def</span><span class="w"> </span><span class="nf">initialize_positions</span><span class="p">(</span><span class="n">Grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize positions for the grid nodes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Grid</span><span class="o">.</span><span class="n">node_positions</span> <span class="k">if</span> <span class="n">Grid</span><span class="o">.</span><span class="n">node_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assign_layout_to_missing_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign layout to nodes missing positions.&quot;&quot;&quot;</span>
    <span class="n">missing_nodes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos</span> <span class="ow">or</span> <span class="n">pos</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pos</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_nodes</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Attempt to apply planar layout to missing nodes</span>
            <span class="n">pos_missing</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">planar_layout</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">missing_nodes</span><span class="p">))</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pos_missing</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">nx</span><span class="o">.</span><span class="n">NetworkXException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Planar layout failed, falling back to Kamada-Kawai layout.&quot;</span><span class="p">)</span>
            <span class="c1"># Fall back to Kamada-Kawai layout</span>
            <span class="n">pos_missing</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">kamada_kawai_layout</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">missing_nodes</span><span class="p">))</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pos_missing</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos</span>

<span class="k">def</span><span class="w"> </span><span class="nf">assign_converter_positions</span><span class="p">(</span><span class="n">Grid</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign positions for DC nodes using corresponding AC node positions.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Grid</span><span class="o">.</span><span class="n">Converters_ACDC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">conv</span> <span class="ow">in</span> <span class="n">Grid</span><span class="o">.</span><span class="n">Converters_ACDC</span><span class="p">:</span>
            <span class="n">dc_node</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_DC</span>
            <span class="n">ac_node</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">Node_AC</span>
            <span class="k">if</span> <span class="n">ac_node</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">dc_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">ac_node</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AC node </span><span class="si">{</span><span class="n">ac_node</span><span class="si">}</span><span class="s2"> for converter </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is missing in positions.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_positions</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">Grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate positions for nodes in the graph.&quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Initialize positions</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">initialize_positions</span><span class="p">(</span><span class="n">Grid</span><span class="p">)</span>
    
    <span class="c1"># Step 2: Assign layout to missing nodes</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">assign_layout_to_missing_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
    
    <span class="c1"># Step 3: Assign positions for converters</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">assign_converter_positions</span><span class="p">(</span><span class="n">Grid</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pos</span>


<div class="viewcode-block" id="plot_neighbour_graph">
<a class="viewcode-back" href="../../api.html#pyflow_acdc.Graph_and_plot.plot_neighbour_graph">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_neighbour_graph</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">base_node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">proximity</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">Graph_toPlot</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Gn</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">ego_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">proximity</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">node_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node</span><span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_AC</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">node_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">Gn</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">ego_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">proximity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Node name provided not found&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">plot_Graph</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">base_node_size</span><span class="o">=</span><span class="n">base_node_size</span><span class="p">,</span><span class="n">G</span><span class="o">=</span><span class="n">Gn</span><span class="p">)</span></div>


        
<div class="viewcode-block" id="plot_Graph">
<a class="viewcode-back" href="../../api.html#pyflow_acdc.Graph_and_plot.plot_Graph">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_Graph</span><span class="p">(</span><span class="n">Grid</span><span class="p">,</span><span class="n">image_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;inPu&#39;</span><span class="p">,</span><span class="n">grid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">base_node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">G</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">G</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">Graph_toPlot</span>
    
    <span class="n">update_hovertexts</span><span class="p">(</span><span class="n">Grid</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> 
    
    <span class="c1"># Initialize pos with node_positions if provided, else empty dict</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">calculate_positions</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">Grid</span><span class="p">)</span>
 
    <span class="n">lines_ac</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">lines_AC</span> <span class="k">if</span> <span class="n">Grid</span><span class="o">.</span><span class="n">lines_AC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">lines_ac_exp</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">lines_AC_exp</span> <span class="k">if</span> <span class="n">Grid</span><span class="o">.</span><span class="n">lines_AC_exp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">lines_dc</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">lines_DC</span> <span class="k">if</span> <span class="n">Grid</span><span class="o">.</span><span class="n">lines_DC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">nodes_DC</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">nodes_DC</span> <span class="k">if</span> <span class="n">Grid</span><span class="o">.</span><span class="n">nodes_DC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">lines_dc_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lines_dc</span><span class="p">)</span>
    <span class="n">lines_ac_exp_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">lines_ac_exp</span><span class="p">)</span>


    <span class="n">pio</span><span class="o">.</span><span class="n">renderers</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;browser&#39;</span>
    <span class="c1"># Define a color palette for the subgraphs</span>
    <span class="n">color_palette</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span>
    <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;brown&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="s1">&#39;teal&#39;</span><span class="p">,</span>
    <span class="s1">&#39;violet&#39;</span><span class="p">,</span> <span class="s1">&#39;indigo&#39;</span><span class="p">,</span> <span class="s1">&#39;turquoise&#39;</span><span class="p">,</span> <span class="s1">&#39;beige&#39;</span><span class="p">,</span> <span class="s1">&#39;coral&#39;</span><span class="p">,</span> <span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="s1">&#39;olive&#39;</span><span class="p">])</span>
    <span class="c1"># </span>
    <span class="c1"># Find connected components (subgraphs)</span>
    <span class="n">connected_components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    
    
    <span class="n">pos_cache</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="n">node_traces_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edge_traces_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mnode_x_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mnode_y_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mnode_txt_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create traces for each subgraph with a unique color</span>
    <span class="n">edge_traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node_traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mnode_trace</span> <span class="o">=</span> <span class="p">[]</span>
    
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">subgraph_nodes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">connected_components</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_palette</span><span class="p">)</span>
        
        <span class="c1"># Create edge trace for the current subgraph</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">subgraph_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span>
            
            <span class="c1"># Skip lines with np_line == 0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="ow">in</span> <span class="n">lines_dc_set</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">np_line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">line</span> <span class="ow">in</span> <span class="n">lines_ac_exp_set</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">np_line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># Skip plotting for lines where np_line == 0</span>

            <span class="c1"># Set line width based on line type</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines_dc_set</span><span class="p">:</span>
                <span class="n">line_width</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">np_line</span>
            <span class="k">elif</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines_ac_exp_set</span><span class="p">:</span>
                <span class="n">line_width</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">np_line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line_width</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="c1"># Cache positions to avoid repeated access</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">pos_cache</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">pos_cache</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            
            <span class="c1"># Collect midpoint data for marker</span>
            <span class="n">mnode_x_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">mnode_y_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">y0</span> <span class="o">+</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">mnode_txt_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">hover_text</span><span class="p">)</span>
            
            <span class="c1"># Append edge trace data</span>
            <span class="n">edge_traces_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">line_width</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>
        
        <span class="c1"># Process nodes for the current subgraph</span>
        <span class="n">x_subgraph_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_subgraph_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hover_texts_nodes_sub</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">node_sizes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">node_opacities</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">subgraph_nodes</span><span class="p">:</span>
            <span class="n">x_subgraph_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_cache</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">y_subgraph_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_cache</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="c1"># Adjust for DC nodes</span>
            
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_DC</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">Grid</span><span class="o">.</span><span class="n">TEP_run</span><span class="p">:</span>  
                <span class="n">node_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_node_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Nconv</span> <span class="o">-</span> <span class="n">node</span><span class="o">.</span><span class="n">Nconv_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">base_node_size</span><span class="p">,</span> <span class="n">base_node_size</span><span class="p">)</span>
                <span class="n">node_opacity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Nconv</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ConvInv</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_size</span> <span class="o">=</span> <span class="n">base_node_size</span>
                <span class="n">node_opacity</span> <span class="o">=</span> <span class="mf">1.0</span>
            
            <span class="n">hover_texts_nodes_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">hover_text</span><span class="p">)</span>
            <span class="n">node_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_size</span><span class="p">)</span>
            <span class="n">node_opacities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_opacity</span><span class="p">)</span>
        
        <span class="c1"># Collect node trace data</span>
        <span class="n">node_traces_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_subgraph_nodes</span><span class="p">,</span> <span class="n">y_subgraph_nodes</span><span class="p">,</span> <span class="n">node_sizes</span><span class="p">,</span> <span class="n">node_opacities</span><span class="p">,</span> <span class="n">hover_texts_nodes_sub</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>

    
    <span class="c1"># After the loops, create all traces in bulk</span>
    <span class="c1"># Edge Traces</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">line_width</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="n">edge_traces_data</span><span class="p">:</span>
        <span class="n">edge_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">line_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">),</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;hover_text_placeholder&quot;</span><span class="p">,</span>  <span class="c1"># Replace with actual hover text</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span>
        <span class="p">))</span>

    <span class="c1"># Node Traces</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x_subgraph_nodes</span><span class="p">,</span> <span class="n">y_subgraph_nodes</span><span class="p">,</span> <span class="n">node_sizes</span><span class="p">,</span> <span class="n">node_opacities</span><span class="p">,</span> <span class="n">hover_texts_nodes_sub</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node_traces_data</span><span class="p">:</span>
        <span class="n">node_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_subgraph_nodes</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_subgraph_nodes</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="n">node_sizes</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="n">node_opacities</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">hover_texts_nodes_sub</span><span class="p">,</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
            <span class="n">visible</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">))</span>

    <span class="c1"># Create mnode_trace (midpoint node trace) only after processing edges</span>
    <span class="n">mnode_trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">mnode_x_data</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">mnode_y_data</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;%</span><span class="si">{hovertext}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
        <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">hovertext</span><span class="o">=</span><span class="n">mnode_txt_data</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span>
        <span class="p">)</span>
    <span class="p">)</span>
    

    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>  <span class="c1"># Set width</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="c1"># updatemenus=updatemenus</span>
    <span class="p">)</span>
    
    
    
    <span class="c1"># Create figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">edge_traces</span> <span class="o">+</span> <span class="n">node_traces</span> <span class="o">+</span> <span class="p">[</span><span class="n">mnode_trace</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
        
    
    <span class="k">if</span> <span class="n">image_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Load the image</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image_file</span><span class="p">:</span>
                <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">image_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
 
           <span class="c1"># Add background image</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">images</span><span class="o">=</span><span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;data:image/png;base64,</span><span class="si">{</span><span class="n">encoded_image</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">xref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">sizex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sizey</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">sizing</span><span class="o">=</span><span class="s1">&#39;stretch&#39;</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;below&#39;</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
   

       

    
    <span class="c1"># Display plot</span>
    <span class="n">pio</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">fig</span></div>

 
<div class="viewcode-block" id="plot_TS_res">
<a class="viewcode-back" href="../../api.html#pyflow_acdc.Graph_and_plot.plot_TS_res">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_TS_res</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">plotting_choice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">Plot</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Power Generation by price zone&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;Power Generation by generator&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;Curtailment&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;Market Prices&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;AC line loading&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;DC line loading&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;AC/DC Converters&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;Power Generation by generator area chart&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;Power Generation by price zone area chart&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># If plotting_choice is None, ask user to choose</span>
    <span class="k">if</span> <span class="n">plotting_choice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please choose a plotting option:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1: Power Generation by price zone&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2: Power Generation by generator&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3: Curtailment&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4: Market Prices&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;5: AC line loading&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;6: DC line loading&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;7: AC/DC Converters&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;8: Power Generation by generator area chart&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;9: Power Generation by price zone area chart&quot;</span><span class="p">)</span>
        
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter a number between 1 and 9: &quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;Power Generation by price zone&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;Power Generation by generator&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;Curtailment&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;Market Prices&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;AC line loading&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;DC line loading&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;AC/DC Converters&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;Power Generation by generator area chart&#39;</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">plotting_choice</span> <span class="o">=</span> <span class="s1">&#39;Power Generation by price zone area chart&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid choice. Please choose a valid option.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="c1"># Verify that the choice is valid</span>
    <span class="k">if</span> <span class="n">plotting_choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Plot</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid plotting option: </span><span class="si">{</span><span class="n">plotting_choice</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">pio</span><span class="o">.</span><span class="n">renderers</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;browser&#39;</span>
    
    <span class="c1"># Retrieve the time series data for curtailment</span>
    
    <span class="k">if</span> <span class="n">plotting_choice</span> <span class="o">==</span> <span class="s1">&#39;Curtailment&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_series_results</span><span class="p">[</span><span class="s1">&#39;curtailment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
    <span class="k">elif</span> <span class="n">plotting_choice</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Power Generation by generator&#39;</span><span class="p">,</span><span class="s1">&#39;Power Generation by generator area chart&#39;</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_series_results</span><span class="p">[</span><span class="s1">&#39;real_power_opf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">S_base</span>
    <span class="k">elif</span> <span class="n">plotting_choice</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Power Generation by price zone&#39;</span><span class="p">,</span><span class="s1">&#39;Power Generation by price zone area chart&#39;</span><span class="p">]</span> <span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_series_results</span><span class="p">[</span><span class="s1">&#39;real_power_by_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">S_base</span>
    <span class="k">elif</span> <span class="n">plotting_choice</span> <span class="o">==</span> <span class="s1">&#39;Market Prices&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_series_results</span><span class="p">[</span><span class="s1">&#39;prices_by_zone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">plotting_choice</span> <span class="o">==</span> <span class="s1">&#39;AC line loading&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_series_results</span><span class="p">[</span><span class="s1">&#39;ac_line_loading&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
    <span class="k">elif</span> <span class="n">plotting_choice</span> <span class="o">==</span> <span class="s1">&#39;DC line loading&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_series_results</span><span class="p">[</span><span class="s1">&#39;dc_line_loading&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
    <span class="k">elif</span> <span class="n">plotting_choice</span> <span class="o">==</span> <span class="s1">&#39;AC/DC Converters&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">time_series_results</span><span class="p">[</span><span class="s1">&#39;converter_loading&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid</span><span class="o">.</span><span class="n">S_base</span>

        
        
        
    <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>  <span class="c1"># Correct way to get DataFrame columns</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>  <span class="c1"># Assuming the DataFrame index is time</span>
    
    
    <span class="n">layout</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Time Series Plot: </span><span class="si">{</span><span class="n">plotting_choice</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># Set title based on user choice</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;x&quot;</span>
    <span class="p">)</span>

    <span class="n">cumulative_sum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="c1"># Check if we need to stack the areas for specific plotting choices</span>
    <span class="n">stack_areas</span> <span class="o">=</span> <span class="n">plotting_choice</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Power Generation by generator area chart&#39;</span><span class="p">,</span> <span class="s1">&#39;Power Generation by price zone area chart&#39;</span><span class="p">]</span>


    <span class="c1"># Adding traces to the subplots</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">y_values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">stack_areas</span><span class="p">:</span>
            <span class="c1"># print(stack_areas)</span>
            <span class="c1"># If stacking, add the current values to the cumulative sum</span>
            <span class="k">if</span> <span class="n">cumulative_sum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cumulative_sum</span> <span class="o">=</span> <span class="n">y_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Start cumulative sum with the first selected row</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;x+y+name&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_values</span> <span class="o">=</span> <span class="n">cumulative_sum</span> <span class="o">+</span> <span class="n">y_values</span>  <span class="c1"># Stack current on top of cumulative sum</span>
                <span class="n">cumulative_sum</span> <span class="o">=</span> <span class="n">y_values</span>  <span class="c1"># Update cumulative sum</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;x+y+name&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tonexty&#39;</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plot normally (no stacking)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;x+y+name&#39;</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Update layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
    
    <span class="c1"># Show figure</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">create_subgraph_color_dict</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
    
    
    
    <span class="n">color_palette_0</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span>
     <span class="s1">&#39;violet&#39;</span><span class="p">,</span> <span class="s1">&#39;limegreen&#39;</span><span class="p">,</span>  <span class="s1">&#39;salmon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;burlywood&#39;</span><span class="p">,</span> <span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span>
    <span class="p">])</span>
    
    <span class="n">color_palette_1</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span>
     <span class="s1">&#39;darkviolet&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>  <span class="s1">&#39;red&#39;</span><span class="p">,</span>
    <span class="s1">&#39;darkoragne&#39;</span><span class="p">,</span> <span class="s1">&#39;hotpink&#39;</span><span class="p">,</span> <span class="s1">&#39;lightseagreen&#39;</span>
    <span class="p">])</span>
    
    <span class="n">color_palette_2</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span>
         <span class="s1">&#39;darkmagenta&#39;</span><span class="p">,</span> <span class="s1">&#39;darkolivegreen&#39;</span><span class="p">,</span>  <span class="s1">&#39;brown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;darkgoldenrod&#39;</span><span class="p">,</span> <span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="s1">&#39;darkcyan&#39;</span>
    <span class="p">])</span>

    <span class="n">color_palette_3</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">([</span>
     <span class="s1">&#39;orchid&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span>  <span class="s1">&#39;navajowhite&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tan&#39;</span><span class="p">,</span> <span class="s1">&#39;lightpink&#39;</span><span class="p">,</span> <span class="s1">&#39;paleturquoise&#39;</span>
    <span class="p">])</span>
    
    <span class="c1"># Get connected components (subgraphs) of the graph G</span>
    <span class="n">connected_components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    <span class="n">subgraph_color_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MV&#39;</span><span class="p">:{},</span><span class="s1">&#39;HV&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;EHV&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;UHV&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    
    <span class="c1"># Loop through the connected components and assign colors</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">subgraph_nodes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">connected_components</span><span class="p">):</span>
        <span class="n">subgraph_color_dict</span><span class="p">[</span><span class="s1">&#39;MV&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_palette_0</span><span class="p">)</span> 
        <span class="n">subgraph_color_dict</span><span class="p">[</span><span class="s1">&#39;HV&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_palette_1</span><span class="p">)</span> 
        <span class="n">subgraph_color_dict</span><span class="p">[</span><span class="s1">&#39;EHV&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_palette_2</span><span class="p">)</span> 
        <span class="n">subgraph_color_dict</span><span class="p">[</span><span class="s1">&#39;UHV&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_palette_3</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">subgraph_color_dict</span>



<div class="viewcode-block" id="plot_folium">
<a class="viewcode-back" href="../../api.html#pyflow_acdc.Graph_and_plot.plot_folium">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_folium</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;inPu&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;grid_map&#39;</span><span class="p">,</span><span class="n">tiles</span><span class="o">=</span><span class="s2">&quot;CartoDB Positron&quot;</span><span class="p">,</span><span class="n">polygon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ant_path</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">clustering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">coloring</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># &quot;OpenStreetMap&quot;,     &quot;CartoDB Positron&quot;     &quot;Cartodb dark_matter&quot; </span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">map_tac</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Needed packages not installed&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">update_hovertexts</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> 

  
    <span class="c1"># Initialize the map, centred around the North Sea</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">tiles</span><span class="o">=</span><span class="n">tiles</span><span class="p">,</span><span class="n">zoom_start</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    
    
    <span class="n">G</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">Graph_toPlot</span>  <span class="c1"># Assuming this is your main graph object</span>
    <span class="n">subgraph_colors</span><span class="o">=</span> <span class="n">create_subgraph_color_dict</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">subgraph_dict</span> <span class="o">=</span> <span class="p">{}</span> 
    
    <span class="c1"># Map each line to its subgraph index</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">subgraph_nodes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">subgraph_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">]</span>
            <span class="n">subgraph_dict</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">subgraph_nodes</span><span class="p">:</span>    
            <span class="n">subgraph_dict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="n">connected_gens</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;connected_gen&#39;</span><span class="p">,</span> <span class="p">[])</span>  
            <span class="n">connected_renSources</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;connected_RenSource&#39;</span><span class="p">,</span> <span class="p">[])</span>  
            <span class="n">subgraph_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">gen</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">connected_gens</span><span class="p">})</span>
            <span class="n">subgraph_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">rs</span><span class="p">:</span>  <span class="n">idx</span> <span class="k">for</span> <span class="n">rs</span>  <span class="ow">in</span> <span class="n">connected_renSources</span><span class="p">})</span>
    
    <span class="c1"># Extract line data (AC and HVDC) into a GeoDataFrame</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_line_data</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">line_type</span><span class="p">):</span>
        <span class="n">line_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">line_type</span> <span class="o">==</span> <span class="s1">&#39;DC&#39;</span><span class="p">:</span> 
            <span class="n">subgraph_dc_counts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line_obj</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">subgraph_idx</span> <span class="o">=</span> <span class="n">subgraph_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">line_obj</span><span class="p">)</span>  <span class="c1"># Avoid KeyError</span>
                <span class="k">if</span> <span class="n">subgraph_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Ensure the line is in subgraph_dict</span>
                    <span class="n">subgraph_dc_counts</span><span class="p">[</span><span class="n">subgraph_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgraph_dc_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subgraph_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span>
            <span class="n">min_loss</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>
            <span class="n">max_loss</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_loss</span> <span class="o">==</span> <span class="n">max_loss</span><span class="p">:</span>
                <span class="n">max_loss</span> <span class="o">+=</span> <span class="mf">0.1</span> 
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">branca</span><span class="o">.</span><span class="n">colormap</span><span class="o">.</span><span class="n">LinearColormap</span><span class="p">(</span>
                <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">],</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">min_loss</span><span class="p">,</span> 
                <span class="n">vmax</span><span class="o">=</span><span class="n">max_loss</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;Efficiency&#39;</span><span class="p">:</span>
           <span class="n">colormap</span> <span class="o">=</span> <span class="n">branca</span><span class="o">.</span><span class="n">colormap</span><span class="o">.</span><span class="n">LinearColormap</span><span class="p">(</span>
               <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="s2">&quot;green&quot;</span><span class="p">],</span>
               <span class="n">vmin</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> 
               <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span>
               <span class="p">)</span>
        <span class="c1"># test_values = [min_loss, (min_loss + max_loss) / 2, max_loss]</span>
        <span class="c1"># for val in test_values:</span>
        <span class="c1">#     print(f&quot;Loss: {val}, Color: {colormap(val)}&quot;)</span>
        <span class="k">for</span> <span class="n">line_obj</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">subgraph_idx</span> <span class="o">=</span> <span class="n">subgraph_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">line_obj</span><span class="p">)</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">line_obj</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Ensure geometry exists</span>
            <span class="n">VL</span> <span class="o">=</span> <span class="s1">&#39;MV&#39;</span> <span class="k">if</span> <span class="n">line_obj</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">110</span> <span class="k">else</span> \
                 <span class="s1">&#39;HV&#39;</span> <span class="k">if</span> <span class="n">line_obj</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="k">else</span> \
                 <span class="s1">&#39;EHV&#39;</span> <span class="k">if</span> <span class="n">line_obj</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">500</span> <span class="k">else</span> \
                 <span class="s1">&#39;UHV&#39;</span>
                 
            <span class="n">line_type_indv</span><span class="o">=</span> <span class="n">line_type</span>    
            
            <span class="k">if</span> <span class="n">line_type_indv</span> <span class="o">==</span> <span class="s1">&#39;DC&#39;</span> <span class="ow">and</span> <span class="n">subgraph_dc_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subgraph_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
               <span class="n">line_type_indv</span> <span class="o">=</span> <span class="s1">&#39;MTDC&#39;</span>
            
            
            <span class="n">area</span> <span class="o">=</span> <span class="n">line_obj</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">PZ</span> <span class="k">if</span> <span class="n">line_obj</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">PZ</span> <span class="o">==</span> <span class="n">line_obj</span><span class="o">.</span><span class="n">fromNode</span><span class="o">.</span><span class="n">PZ</span> <span class="k">else</span> <span class="s1">&#39;ICL&#39;</span>
            <span class="n">ant_v</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="n">area</span> <span class="o">==</span> <span class="s1">&#39;ICL&#39;</span> <span class="ow">or</span> <span class="n">line_type</span> <span class="o">==</span> <span class="s1">&#39;DC&#39;</span><span class="p">:</span>
                <span class="n">ant_v</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">ant_path</span> <span class="o">==</span> <span class="s1">&#39;All&#39;</span> <span class="ow">and</span> <span class="n">VL</span> <span class="o">!=</span> <span class="s1">&#39;MV&#39;</span><span class="p">:</span>
                <span class="n">ant_v</span> <span class="o">=</span> <span class="kc">True</span>
           
            <span class="k">if</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">line_obj</span><span class="o">.</span><span class="n">loss</span><span class="p">))</span>
                <span class="c1"># print(f&#39;{np.real(line.loss)} - {color}&#39;)</span>
            <span class="k">elif</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;Efficiency&#39;</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">line_obj</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line_type</span><span class="o">==</span> <span class="s1">&#39;DC&#39;</span><span class="p">:</span>
                    <span class="n">power</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line_obj</span><span class="o">.</span><span class="n">fromP</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line_obj</span><span class="o">.</span><span class="n">toP</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">power</span> <span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">line_obj</span><span class="o">.</span><span class="n">fromS</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">line_obj</span><span class="o">.</span><span class="n">toS</span><span class="p">)))</span>
                <span class="n">eff</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">loss</span><span class="o">/</span><span class="n">power</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="k">if</span> <span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">color</span><span class="o">=</span> <span class="n">colormap</span><span class="p">(</span><span class="n">eff</span><span class="p">)</span>
                <span class="c1"># print(f&#39;{eff} - {color}&#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;black&#39;</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">line_obj</span><span class="p">,</span> <span class="s1">&#39;isTf&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># Defaults to False if &#39;isTF&#39; does not exist/</span>
                        <span class="k">else</span> <span class="n">subgraph_colors</span><span class="p">[</span><span class="n">VL</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subgraph_idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line_type</span> <span class="o">==</span> <span class="s1">&#39;AC&#39;</span> 
                        <span class="k">else</span> <span class="s1">&#39;darkblue&#39;</span> <span class="k">if</span> <span class="n">line_type_indv</span> <span class="o">==</span> <span class="s1">&#39;MTDC&#39;</span> 
                        <span class="k">else</span> <span class="s1">&#39;royalblue&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geometry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="n">line_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">line_type_indv</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">line_obj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;Direction&quot;</span><span class="p">:</span> <span class="n">line_obj</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
                    <span class="s2">&quot;ant_viable&quot;</span><span class="p">:</span> <span class="n">ant_v</span><span class="p">,</span> 
                    <span class="s2">&quot;thck&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">line_obj</span><span class="p">,</span> <span class="s1">&#39;np_line&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="s2">&quot;VL&quot;</span> <span class="p">:</span><span class="n">VL</span><span class="p">,</span>
                    <span class="s2">&quot;area&quot;</span><span class="p">:</span><span class="n">area</span><span class="p">,</span>
                    <span class="s2">&quot;tf&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">line_obj</span><span class="p">,</span> <span class="s1">&#39;isTf&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s2">&quot;hover_text&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">line_obj</span><span class="p">,</span> <span class="s1">&#39;hover_text&#39;</span><span class="p">,</span> <span class="s1">&#39;No info&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span><span class="n">color</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">line_data</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create GeoDataFrames for AC and HVDC lines</span>
    <span class="n">gdf_lines_AC</span> <span class="o">=</span> <span class="n">extract_line_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lines_AC</span><span class="o">+</span><span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_tf</span><span class="p">,</span> <span class="s2">&quot;AC&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_exp</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">gdf_lines_AC_exp</span> <span class="o">=</span> <span class="n">extract_line_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_exp</span><span class="p">,</span> <span class="s2">&quot;AC&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_lines_AC_exp</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;VL&quot;</span><span class="p">,</span> <span class="s2">&quot;tf&quot;</span><span class="p">,</span> <span class="s2">&quot;hover_text&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">])</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_vl_and_tf</span><span class="p">(</span><span class="n">gdf</span><span class="p">):</span>
    <span class="c1"># Filter lines based on Voltage Level (VL)</span>
        <span class="n">AC_mv</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;VL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MV&#39;</span><span class="p">]</span>    
        <span class="n">AC_hv</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;VL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HV&#39;</span><span class="p">]</span>
        <span class="n">AC_ehv</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;VL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EHV&#39;</span><span class="p">]</span>
        <span class="n">AC_uhv</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;VL&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;UHV&#39;</span><span class="p">]</span>
    
        <span class="c1"># Filter transformer lines (isTf == True)</span>
        <span class="n">AC_tf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;tf&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;tf&#39;</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">AC_mv</span><span class="p">,</span><span class="n">AC_hv</span><span class="p">,</span> <span class="n">AC_ehv</span><span class="p">,</span> <span class="n">AC_uhv</span><span class="p">,</span> <span class="n">AC_tf</span>
   
    <span class="n">gdf_lines_AC_mv</span><span class="p">,</span><span class="n">gdf_lines_AC_hv</span><span class="p">,</span> <span class="n">gdf_lines_AC_ehv</span><span class="p">,</span> <span class="n">gdf_lines_AC_uhv</span><span class="p">,</span> <span class="n">gdf_lines_AC_tf</span><span class="o">=</span><span class="n">filter_vl_and_tf</span><span class="p">(</span><span class="n">gdf_lines_AC</span><span class="p">)</span>
 
    <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_DC</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">gdf_lines_HVDC</span> <span class="o">=</span> <span class="n">extract_line_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">lines_DC</span><span class="p">,</span> <span class="s2">&quot;DC&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_lines_HVDC</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;VL&quot;</span><span class="p">,</span> <span class="s2">&quot;tf&quot;</span><span class="p">,</span> <span class="s2">&quot;hover_text&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">])</span>
        
        
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_conv_data</span><span class="p">(</span><span class="n">converters</span><span class="p">):</span>
        <span class="n">line_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conv_obj</span> <span class="ow">in</span> <span class="n">converters</span><span class="p">:</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conv_obj</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Ensure geometry exists</span>
            <span class="k">if</span> <span class="n">geometry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="n">line_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;conv&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;area&quot;</span><span class="p">:</span><span class="n">conv_obj</span><span class="o">.</span><span class="n">Node_DC</span><span class="o">.</span><span class="n">PZ</span><span class="p">,</span>
                    <span class="s2">&quot;ant_viable&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;thck&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conv_obj</span><span class="p">,</span> <span class="s1">&#39;NumConvP&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conv_obj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;hover_text&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conv_obj</span><span class="p">,</span> <span class="s1">&#39;hover_text&#39;</span><span class="p">,</span> <span class="s1">&#39;No info&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s1">&#39;purple&#39;</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">line_data</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">Converters_ACDC</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">gdf_conv</span> <span class="o">=</span> <span class="n">extract_conv_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">Converters_ACDC</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_conv</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;hover_text&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">])</span>
    
    <span class="c1"># Extract node data into a GeoDataFrame</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_node_data</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
        
        <span class="n">node_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">subgraph_idx</span> <span class="o">=</span> <span class="n">subgraph_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">VL</span> <span class="o">=</span> <span class="s1">&#39;MV&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">110</span> <span class="k">else</span> \
                 <span class="s1">&#39;HV&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="k">else</span> \
                 <span class="s1">&#39;EHV&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">500</span> <span class="k">else</span> \
                 <span class="s1">&#39;UHV&#39;</span>
            <span class="k">if</span> <span class="n">geometry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="n">node_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;VL&quot;</span> <span class="p">:</span><span class="n">VL</span><span class="p">,</span>
                    <span class="s2">&quot;area&quot;</span><span class="p">:</span><span class="n">node</span><span class="o">.</span><span class="n">PZ</span><span class="p">,</span>
                    <span class="s2">&quot;hover_text&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;hover_text&#39;</span><span class="p">,</span> <span class="s1">&#39;No info&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;AC&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node_AC</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;DC&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">subgraph_colors</span><span class="p">[</span><span class="n">VL</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subgraph_idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node_AC</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;blue&quot;</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">node_data</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>

    <span class="c1"># Create GeoDataFrame for nodes</span>
    <span class="n">gdf_nodes_AC</span> <span class="o">=</span> <span class="n">extract_node_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">nodes_AC</span><span class="p">)</span>
    
    <span class="n">gdf_nodes_AC_mv</span><span class="p">,</span><span class="n">gdf_nodes_AC_hv</span><span class="p">,</span> <span class="n">gdf_nodes_AC_ehv</span><span class="p">,</span> <span class="n">gdf_nodes_AC_uhv</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="n">filter_vl_and_tf</span><span class="p">(</span><span class="n">gdf_nodes_AC</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_DC</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">gdf_nodes_DC</span> <span class="o">=</span> <span class="n">extract_node_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">nodes_DC</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_nodes_DC</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;VL&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span><span class="s2">&quot;hover_text&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
        
        
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_gen_data</span><span class="p">(</span><span class="n">gens</span><span class="p">):</span>
        <span class="n">gen_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">:</span>
            <span class="n">subgraph_idx</span> <span class="o">=</span> <span class="n">subgraph_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">VL</span> <span class="o">=</span> <span class="s1">&#39;HV&#39;</span> <span class="k">if</span> <span class="n">gen</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="k">else</span> \
                 <span class="s1">&#39;EHV&#39;</span> <span class="k">if</span> <span class="n">gen</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">500</span> <span class="k">else</span> \
                 <span class="s1">&#39;UHV&#39;</span>
            <span class="k">if</span> <span class="n">geometry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="n">gen_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;VL&quot;</span> <span class="p">:</span><span class="n">VL</span><span class="p">,</span>
                    <span class="s2">&quot;area&quot;</span><span class="p">:</span><span class="n">gen</span><span class="o">.</span><span class="n">PZ</span><span class="p">,</span>
                    <span class="s2">&quot;hover_text&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="s1">&#39;hover_text&#39;</span><span class="p">,</span> <span class="s1">&#39;No info&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">gen</span><span class="o">.</span><span class="n">gen_type</span><span class="p">,</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">subgraph_colors</span><span class="p">[</span><span class="n">VL</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subgraph_idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span> 
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">gen_data</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">Generators</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">gdf_gens</span> <span class="o">=</span> <span class="n">extract_gen_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">Generators</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_gens</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;VL&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span><span class="s2">&quot;hover_text&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
    
    
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_renSource_data</span><span class="p">(</span><span class="n">renSources</span><span class="p">):</span>
        <span class="n">gen_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">renSources</span><span class="p">:</span>
            <span class="n">subgraph_idx</span> <span class="o">=</span> <span class="n">subgraph_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">VL</span> <span class="o">=</span> <span class="s1">&#39;HV&#39;</span> <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="k">else</span> \
                 <span class="s1">&#39;EHV&#39;</span> <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">kV_base</span> <span class="o">&lt;</span> <span class="mi">500</span> <span class="k">else</span> \
                 <span class="s1">&#39;UHV&#39;</span>
            <span class="k">if</span> <span class="n">geometry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">geometry</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="n">gen_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;VL&quot;</span> <span class="p">:</span><span class="n">VL</span><span class="p">,</span>
                    <span class="s2">&quot;area&quot;</span><span class="p">:</span><span class="n">rs</span><span class="o">.</span><span class="n">PZ</span><span class="p">,</span>
                    <span class="s2">&quot;hover_text&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s1">&#39;hover_text&#39;</span><span class="p">,</span> <span class="s1">&#39;No info&#39;</span><span class="p">),</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">rs</span><span class="o">.</span><span class="n">rs_type</span><span class="p">,</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">subgraph_colors</span><span class="p">[</span><span class="n">VL</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subgraph_idx</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span> 
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">gen_data</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">RenSources</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">gdf_rsSources</span> <span class="o">=</span> <span class="n">extract_renSource_data</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">RenSources</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_rsSources</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;VL&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span><span class="s2">&quot;hover_text&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>

    
    <span class="c1"># Function to add LineString geometries to the map</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_lines</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">tech_name</span><span class="p">,</span><span class="n">ant</span><span class="p">):</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">coords</span><span class="p">]</span>  <span class="c1"># Folium needs (lat, lon) order</span>
            
            <span class="k">if</span> <span class="n">ant</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ant_viable&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Add animated AntPath</span>
                <span class="n">AntPath</span><span class="p">(</span>
                    <span class="n">locations</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                    <span class="n">weight</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;thck&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HVDC&quot;</span> <span class="k">else</span> <span class="mi">2</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;thck&quot;</span><span class="p">],</span>  <span class="c1"># HVDC lines slightly thicker</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">delay</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>  <span class="c1"># Adjust animation speed</span>
                    <span class="n">popup</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;hover_text&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">tech_name</span><span class="p">)</span>
    
            <span class="k">else</span><span class="p">:</span>
        
                <span class="n">folium</span><span class="o">.</span><span class="n">PolyLine</span><span class="p">(</span>
                    <span class="n">coords</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                    <span class="n">weight</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;thck&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HVDC&quot;</span> <span class="k">else</span> <span class="mi">2</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;thck&quot;</span><span class="p">],</span>  <span class="c1"># HVDC lines slightly thicker</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">popup</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;hover_text&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">tech_name</span><span class="p">)</span>
           
    
    
    <span class="c1"># Function to add nodes with filtering by type and zone</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_nodes</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">tech_name</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Check if the node matches the filter criteria (both type and zone)</span>
            <span class="n">folium</span><span class="o">.</span><span class="n">CircleMarker</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>  <span class="c1"># (lat, lon)</span>
                <span class="n">radius</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;AC&quot;</span> <span class="k">else</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># DC nodes slightly larger</span>
                <span class="n">color</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fill_opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">popup</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;hover_text&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">tech_name</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">add_markers</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">tech_name</span><span class="p">):</span>  
        
        <span class="k">if</span> <span class="n">clustering</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">MarkerCluster</span><span class="p">()</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">tech_name</span><span class="p">)</span>  <span class="c1"># Add clustering per type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">tech_name</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            
            <span class="n">typ</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="c1"># Ensure valid coordinates (lat, lon)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># For Python 3.9+</span>
                    <span class="k">with</span> <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;pyflow_acdc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;folium_images&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">icon_path</span><span class="p">:</span>
                        <span class="n">icon_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">icon_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Fallback for older Python versions</span>
                    <span class="n">icon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;folium_images&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
                    
                <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
                    <span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">),</span>  <span class="c1"># (lat, lon)</span>
                    <span class="n">popup</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;hover_text&quot;</span><span class="p">],</span>  <span class="c1"># Display name on click</span>
                    <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">CustomIcon</span><span class="p">(</span>
                        <span class="n">icon_image</span><span class="o">=</span><span class="n">icon_path</span><span class="p">,</span>  
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
                
    
    
    <span class="n">mv_AC</span>  <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;MVAC Lines &lt;110kV&quot;</span><span class="p">)</span>
    <span class="n">hv_AC</span>  <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;HVAC Lines &lt;300kV&quot;</span><span class="p">)</span>
    <span class="n">ehv_AC</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;HVAC Lines &lt;500kV&quot;</span><span class="p">)</span>
    <span class="n">uhv_AC</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;HVAC Lines&quot;</span><span class="p">)</span>
    <span class="n">hvdc</span>   <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;HVDC Lines&quot;</span><span class="p">)</span>
    <span class="n">convs</span>  <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Converters&quot;</span><span class="p">)</span>
    <span class="n">transformers</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Transformers&quot;</span><span class="p">)</span>
    <span class="n">exp_lines</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Exp Lines&quot;</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">ant_path</span> <span class="o">==</span> <span class="s1">&#39;All&#39;</span> <span class="ow">or</span> <span class="n">ant_path</span> <span class="o">==</span> <span class="s1">&#39;Reduced&#39;</span><span class="p">:</span>
        <span class="n">ant</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ant</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_lines_AC_mv</span><span class="p">,</span> <span class="n">mv_AC</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>    
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_lines_AC_hv</span><span class="p">,</span> <span class="n">hv_AC</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_lines_AC_ehv</span><span class="p">,</span> <span class="n">ehv_AC</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_lines_AC_uhv</span><span class="p">,</span> <span class="n">uhv_AC</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_lines_AC_exp</span><span class="p">,</span> <span class="n">exp_lines</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_lines_AC_tf</span><span class="p">,</span> <span class="n">transformers</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_lines_HVDC</span><span class="p">,</span> <span class="n">hvdc</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>
    <span class="n">add_lines</span><span class="p">(</span><span class="n">gdf_conv</span><span class="p">,</span> <span class="n">convs</span><span class="p">,</span> <span class="n">ant</span><span class="p">)</span>
    
    <span class="n">add_nodes</span><span class="p">(</span><span class="n">gdf_nodes_AC_mv</span><span class="p">,</span> <span class="n">mv_AC</span><span class="p">)</span>
    <span class="n">add_nodes</span><span class="p">(</span><span class="n">gdf_nodes_AC_hv</span><span class="p">,</span> <span class="n">hv_AC</span><span class="p">)</span>
    <span class="n">add_nodes</span><span class="p">(</span><span class="n">gdf_nodes_AC_ehv</span><span class="p">,</span> <span class="n">ehv_AC</span><span class="p">)</span>
    <span class="n">add_nodes</span><span class="p">(</span><span class="n">gdf_nodes_AC_uhv</span><span class="p">,</span> <span class="n">uhv_AC</span><span class="p">)</span>
    <span class="n">add_nodes</span><span class="p">(</span><span class="n">gdf_nodes_DC</span><span class="p">,</span> <span class="n">hvdc</span><span class="p">)</span>

    <span class="n">layer_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Nuclear&quot;</span><span class="p">,</span> <span class="s2">&quot;Hard Coal&quot;</span><span class="p">,</span> <span class="s2">&quot;Hydro&quot;</span><span class="p">,</span> <span class="s2">&quot;Oil&quot;</span><span class="p">,</span> <span class="s2">&quot;Lignite&quot;</span><span class="p">,</span> <span class="s2">&quot;Natural Gas&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Solid Biomass&quot;</span><span class="p">,</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span> <span class="s2">&quot;Waste&quot;</span><span class="p">,</span> <span class="s2">&quot;Biogas&quot;</span><span class="p">,</span> <span class="s2">&quot;Geothermal&quot;</span>
    <span class="p">]</span>
    <span class="c1"># Dictionary to store FeatureGroups for each generation type</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">folium</span><span class="o">.</span><span class="n">FeatureGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">}</span>
    
    
    <span class="c1"># Add filtered layers to map</span>
    <span class="n">mv_AC</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mv_AC</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">hv_AC</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hv_AC</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ehv_AC</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ehv_AC</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">uhv_AC</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uhv_AC</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">hvdc</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvdc</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">convs</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">convs</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">transformers</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transformers</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">exp_lines</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_lines</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        
    <span class="c1"># Split gdf_gens by type and add markers for each type</span>
    <span class="k">for</span> <span class="n">gen_type</span><span class="p">,</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">gdf_gens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">):</span>  <span class="c1"># Split by &#39;type&#39;</span>
        <span class="k">if</span> <span class="n">gen_type</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">add_markers</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="n">gen_type</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">gen_type</span><span class="p">,</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">gdf_rsSources</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">):</span>  <span class="c1"># Split by &#39;type&#39;</span>
        <span class="k">if</span> <span class="n">gen_type</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">add_markers</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="n">gen_type</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check if the layer has children</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">polygon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span>
            <span class="n">polygon</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Area to Study&quot;</span><span class="p">,</span>
            <span class="n">style_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;opacity&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">},</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">Draw</span><span class="p">(</span>   <span class="n">export</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Allows downloading edited layers</span>
            <span class="n">edit_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;poly&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;allowIntersection&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span>  <span class="c1"># Prevents self-intersecting edits</span>
            <span class="n">draw_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;polygon&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;polyline&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="c1"># Draw().add_to(m)</span>
    <span class="k">if</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;Efficiency&#39;</span><span class="p">:</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">branca</span><span class="o">.</span><span class="n">colormap</span><span class="o">.</span><span class="n">LinearColormap</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">],</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> 
            <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span>
            <span class="p">)</span>
        <span class="n">colormap</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="s2">&quot;Efficiency Scale&quot;</span>  <span class="c1"># Optional: Set a caption for clarity</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
        
    <span class="c1"># Add layer control</span>
    <span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">()</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="c1"># Save and display the map</span>
    <span class="n">map_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.html&quot;</span>
    <span class="c1"># Save and display the map</span>
    <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">map_filename</span><span class="p">)</span>  <span class="c1"># Open this file in a browser to viewm</span>
    <span class="n">abs_map_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">map_filename</span><span class="p">)</span>
    
    <span class="c1"># Automatically open the map in the default web browser</span>
    <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file://</span><span class="si">{</span><span class="n">abs_map_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">save_network_svg</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;grid_network&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the network as SVG file&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">svgwrite</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current working directory: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Will save as: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Create SVG drawing</span>
        <span class="n">dwg</span> <span class="o">=</span> <span class="n">svgwrite</span><span class="o">.</span><span class="n">Drawing</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.svg&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s1">px&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s1">px&#39;</span><span class="p">),</span> <span class="n">profile</span><span class="o">=</span><span class="s1">&#39;tiny&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get all geometries and their bounds</span>
        <span class="n">all_bounds</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Add lines</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_tf</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_DC</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                <span class="n">all_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
                
        <span class="c1"># Add nodes</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_AC</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_DC</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                <span class="n">all_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
                
        <span class="c1"># Add generators and renewable sources</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">Generators</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">RenSources</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gen</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                <span class="n">all_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
        
        <span class="c1"># Calculate overall bounds</span>
        <span class="k">if</span> <span class="n">all_bounds</span><span class="p">:</span>
            <span class="n">minx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">all_bounds</span><span class="p">)</span>
            <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">all_bounds</span><span class="p">)</span>
            <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">all_bounds</span><span class="p">)</span>
            <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bound</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">all_bounds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No geometries found to plot&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Calculate scaling factors</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># pixels of padding</span>
        <span class="n">scale_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">padding</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>
        <span class="n">scale_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">padding</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">transform_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Transform coordinates to SVG space&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">padding</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                <span class="n">height</span> <span class="o">-</span> <span class="p">(</span><span class="n">padding</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">miny</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># Flip Y axis</span>
            <span class="p">)</span>
        
        <span class="c1"># Draw AC lines</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_AC_tf</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
                <span class="n">path_data</span> <span class="o">=</span> <span class="s2">&quot;M &quot;</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
                    <span class="n">svg_x</span><span class="p">,</span> <span class="n">svg_y</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">path_data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">svg_x</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">svg_y</span><span class="si">}</span><span class="s2"> L &quot;</span>
                <span class="n">path_data</span> <span class="o">=</span> <span class="n">path_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Remove last &quot;L &quot;</span>
                
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">&#39;isTf&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
                <span class="n">dwg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dwg</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">path_data</span><span class="p">,</span> <span class="n">stroke</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">stroke_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
        
        <span class="c1"># Draw DC lines</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">lines_DC</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
                <span class="n">path_data</span> <span class="o">=</span> <span class="s2">&quot;M &quot;</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
                    <span class="n">svg_x</span><span class="p">,</span> <span class="n">svg_y</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">path_data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">svg_x</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">svg_y</span><span class="si">}</span><span class="s2"> L &quot;</span>
                <span class="n">path_data</span> <span class="o">=</span> <span class="n">path_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">dwg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dwg</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">path_data</span><span class="p">,</span> <span class="n">stroke</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">stroke_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
        
        <span class="c1"># Draw nodes</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_AC</span> <span class="o">+</span> <span class="n">grid</span><span class="o">.</span><span class="n">nodes_DC</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>
                <span class="n">svg_x</span><span class="p">,</span> <span class="n">svg_y</span> <span class="o">=</span> <span class="n">transform_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node_AC</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;purple&quot;</span>
                <span class="n">dwg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dwg</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">svg_x</span><span class="p">,</span> <span class="n">svg_y</span><span class="p">),</span> <span class="n">r</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                 <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">stroke</span><span class="o">=</span><span class="n">color</span><span class="p">))</span>
        
                
        <span class="c1"># Save the SVG file</span>
        <span class="n">dwg</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network saved as </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not save SVG: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Please install svgwrite package.&quot;</span><span class="p">)</span>


    <span class="k">return</span> 


    
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pyflow acdc</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Bernardo Castro Valerio.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.1</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>