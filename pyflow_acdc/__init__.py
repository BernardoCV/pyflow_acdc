# -*- coding: utf-8 -*-
"""
PyFlow-ACDC initialization module.
Provides grid simulation and power flow analysis functionality.
"""
from pathlib import Path
import importlib.util

# Core imports - required modules
from .Results_class import *
from .Class_editor import *
from .Grid_creator import *
from .Classes import *
from .Export_files import *
from .Time_series import *
from .ACDC_PF import *
from .Graph_and_plot import *
from .Market_Coeff import *

# Define what should be available when users do: from pyflow_acdc import *
__all__ = [
    # Results
    'Results',
    # Grid
    'Grid', 
    'Node_AC',
    'Node_DC',
    'Line_AC',
    'Line_DC',
    'AC_DC_converter',

    # Add Grid Elements
    'add_AC_node',
    'add_DC_node',
    'add_line_AC',
    'add_line_DC',
    'add_ACDC_converter',
    'add_DCDC_converter',
    'add_gen',
    'add_gen_DC',
    'add_extGrid',
    'add_RenSource',
    'add_generators',
    
    # Add Zones
    'add_RenSource_zone',
    'add_price_zone',
    'add_MTDC_price_zone',
    'add_offshore_price_zone',
    
    # Add Time Series
    'add_TimeSeries',
    
    #Add investment series
    'add_inv_series',
    
    # Grid Creation and Import
    'Create_grid_from_data',
    'Create_grid_from_mat',
    'Create_grid_from_turbine_graph',
    'Extend_grid_from_data',
    'Create_grid_from_pickle',
    
    # Line Modifications
    'change_line_AC_to_expandable',
    'change_line_AC_to_tap_transformer',
    
    # Zone Assignments
    'assign_RenToZone',
    'assign_nodeToPrice_Zone',
    'assign_ConvToPrice_Zone',
    
    # Parameter Calculations
    'Cable_parameters',
    'Converter_parameters',
    
    # Utility Functions
    'pol2cart',
    'cart2pol',
    'pol2cartz',
    'cartz2pol',
    'initialize_pyflowacdc',
    
    # Power Flow
    'AC_PowerFlow',
    'DC_PowerFlow',
    'ACDC_sequential',
    'Power_flow',
    
    # Time Series Analysis
    'Time_series_PF',
    'TS_ACDC_PF',
    'Time_series_statistics',
    'update_grid_data',
    
    # Export
    'export_results_to_excel',
    'export_OPF_results_to_excel',
    'save_grid_to_file',
    'save_grid_to_matlab',
    'save_pickle',
    'export_solver_progress_to_excel',

    # Visualization
    'plot_Graph',
    'Time_series_prob',
    'plot_neighbour_graph',
    'plot_TS_res',
    'save_network_svg',
    'plot_model_feasebility',
    
    # Market Analysis
    'price_zone_data_pd',
    'price_zone_coef_data',
    'plot_curves',
    'clean_entsoe_data',
    'update_grid_price_zone_data',
]

# Try to import OPF module if pyomo is available
try:
    from .ACDC_OPF import *
    # Time_series module functions that depend on OPF are already imported via Time_series
    # but we need to add them to __all__ only if OPF is available
    __all__.extend([
        'Optimal_PF', 'Optimal_L_PF', 'pyomo_model_solve', 'OPF_obj', 'OPF_line_res',
        'OPF_price_priceZone', 'OPF_conv_results', 'Translate_pyf_OPF',
        'TS_ACDC_OPF', 'TS_ACDC_OPF_parallel', 'results_TS_OPF'
    ])
    HAS_OPF = True
    
    # ACDC_Static_TEP also requires OPF/pyomo
    try:
        from .ACDC_Static_TEP import *
        __all__.extend([
            'transmission_expansion', 'linear_transmission_expansion',
            'multi_scenario_TEP', 'expand_elements_from_pd',
            'repurpose_element_from_pd', 'update_attributes', 'Expand_element',
            'Translate_pd_TEP', 'export_TEP_TS_results_to_excel',
            'alpha_paretto', 'rate_sensitivity', 'kappa_sensitivity',
            'comprehensive_sensitivity_analysis'
        ])
    except ImportError:
        pass
    
    # Array_OPT depends on both OPF and Static_TEP modules
    try:
        from .Array_OPT import *
        __all__.extend(['simple_CSS', 'sequential_CSS', 'MIP_path_graph'])
    except ImportError:
        pass
    
except ImportError:
    HAS_OPF = False

try:
    from .ACDC_Dynamic_TEP import *
    __all__.extend(['multi_period_TEP', 'multi_period_MS_TEP', 'export_and_save_inv_period_svgs'])
except ImportError:
    pass
    
try:
    from .ACDC_TEP_pymoo import *
    __all__.append('transmission_expansion_pymoo')
    HAS_TEP_PYMOO = True
except ImportError:
    HAS_TEP_PYMOO = False

try:
    from .Graph_Dash import *
    __all__.append('run_dash')
    HAS_DASH = True
except ImportError:
    HAS_DASH = False
    
try:
    from .AC_L_CSS_gurobi import *
    __all__.extend(['Optimal_L_CSS_gurobi', 'test_master_problem'])
    HAS_AC_L_CSS_GUROBI = True
except ImportError:
    HAS_AC_L_CSS_GUROBI = False

try:
    from .AC_L_CSS_ortools import *
    __all__.extend(['Optimal_L_CSS_ortools'])
    HAS_AC_L_CSS_ORTOOLS = True
except ImportError:
    HAS_AC_L_CSS_ORTOOLS = False

try:
    from .Mapping import *
    HAS_MAPPING = True
except ImportError:
    HAS_MAPPING = False

try:
    from .Time_series_clustering import *
    __all__.extend([
        'cluster_TS', 'run_clustering_analysis_and_plot',
        'identify_correlations', 'cluster_analysis'
    ])
    HAS_CLUSTERING = True
except ImportError:
    HAS_CLUSTERING = False

# Dynamically load all .py files in the 'cases/' folder
case_folder = Path(__file__).parent / "example_grids"

# Namespace for all loaded cases
cases = {}

# Load each .py file in the cases folder
for case_file in case_folder.glob("*.py"):
    module_name = case_file.stem  # Get the file name without extension
    spec = importlib.util.spec_from_file_location(module_name, case_file)
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    
    # Add all public functions from the module to the `cases` namespace
    cases.update({name: obj for name, obj in vars(module).items() if not name.startswith("_")})

# Optional: Add all cases to this module's global namespace
globals().update(cases)    

